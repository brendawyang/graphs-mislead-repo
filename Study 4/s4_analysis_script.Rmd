---
title: "Data Analysis for Study 4"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: false
---


# Study 4 Introduction

This Markdown documents the process to analyze the data for Study 4 which looked at the difference between those who received and those who did not receive a warning at the beginning of the study and the effects of this warning after a 1 day delay. 

Data was collected between August 7, 2018 and August 9, 2018 by using Amazon's Mechanical Turk for ditribution and Qualtrics as a survey platform. 

This HTML was last knitted on: `r Sys.time()`

# Set Up

## Packages and Libraries

You must run this section before you can run any other chunks.

```{r packages, echo = FALSE}
#Make sure all packages are installed

list.of.packages <- c("readr", "tidyr", "dplyr", "magrittr", "psych", "stringr", "effsize", "shiny", "readr", "lme4", "lmerTest", "kableExtra", "knitr", "ggplot2", "ggthemes", "cowplot", "pwr", "psych", "emmeans", "broom")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
```

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#turn off scientific notation
options(scipen=999)
```

```{r libraries}
#Load all libraries
library(readr)
library(tidyr)
library(dplyr)
library(magrittr)
library(effsize)
library(lme4) # for mixed effects models
library(lmerTest)
library(kableExtra)
library(knitr)#kable
library(pwr)
library(emmeans)
library(broom)

##Raincloud Plot Libraries
source("../R_rainclouds.R")
library(cowplot)
library(ggthemes)
library(ggplot2)

```

### ggplot themes
```{r}
#raincloud plot theme
raincloud_theme <- theme(
  text = element_text(size = 10, color = "black"),
  axis.title.x = element_text(size = 16, color = "black"),
  axis.title.y = element_text(size = 16, color = "black", margin = margin(r = 20)),
  axis.text = element_text(size = 14, color = "black"),
  #axis.text.x = element_text(color = "black"),
  #axis.text.y = element_text(color = "black"),
  legend.title=element_blank(),
  legend.text=element_text(size=16),
  legend.position = "right",
  plot.title = element_text(lineheight=.8, face="bold", size = 16),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.major.y = element_line(colour = 'light gray', size=0.5, linetype='solid'),
  panel.background = element_blank(),
  axis.line = element_blank(), 
  axis.ticks.y = element_blank(),
  strip.text = element_text(size=15, margin = margin(.3,0,.3,0, "cm")),
  strip.background = element_rect(fill="white")
  )

#interaction plot theme
interaction_theme <- theme(
  text = element_text(size = 10),
  axis.title.x = element_text(size = 16),
  axis.title.y = element_text(size = 16, margin = margin(r = 20)),
  axis.text = element_text(size = 12),
  legend.title=element_blank(),
  legend.text=element_text(size=16),
  legend.position = "top", # legend position
  plot.title = element_text(lineheight=.8, face="bold", size = 16),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.major.y = element_line(colour = 'light gray', size=0.5, linetype='solid'),
  panel.background = element_blank(),
  axis.line = element_blank(), 
  axis.ticks.y = element_blank()
)

```


### Data Import

```{r data import}

rating_df <- read_csv("data/clean/s4_rating_df.csv", 
    col_types = cols(graph_condition = col_factor(levels = c("control", 
        "truncated")), session = col_factor(levels = c("1", 
        "2")), subject_condition = col_factor(levels = c("no warning", 
        "warning"))))

demographic_df <- read_csv("data/clean/s4_demographic_df.csv")

graphliteracy_df <- read_csv("data/clean/s4_graphliteracy_df.csv")

debriefing_df <- read_csv("data/clean/s4_debriefing_df.csv")

timing_df <- read_csv("data/clean/s4_timing_df.csv", 
    col_types = cols(graph_condition = col_factor(levels = c("control", 
        "truncated")), session = col_factor(levels = c("1", 
        "2")), subject_condition = col_factor(levels = c("no warning", 
        "warning"))))

```


### Exclusions

You can exclude subjects who did not get the correct answer in the exercise by changing Exclude_Exercise_Check (line 99) to TRUE. The next time you run all the code, these participants will be excluded. 

```{r}
Exclude_Exercise_Check <- FALSE

participants_excluded <- demographic_df %>% 
  filter(check == "wrong") %>% 
  group_by(check) %>% 
  summarise(n = n())

if(Exclude_Exercise_Check == TRUE){rating_df <- rating_df %>% 
  filter(check == "right" | subject_condition == "no warning")
} else{rating_df <- rating_df}

if(Exclude_Exercise_Check == TRUE){demographic_df <- demographic_df %>% 
  filter(check == "right" | subject_condition == "no warning")
} else{demographic_df <- demographic_df}

```

For this report, **`r if(Exclude_Exercise_Check == FALSE){paste("no")} else{paste(participants_excluded$n)}`** participants are being excluded from analysis. 


```{r addtional data frames, eval = TRUE}
#Create data frames that will be used throughout

#Calculate subject means by condition for session 1
##(mean rating for truncated and mean rating for non-truncated graphs)
#NOTE: na.rm = TRUE otherwise any participant who doesn't answer 1 of the questions will have an NA for as a mean. 
subject_mean_df <- rating_df %>%
  group_by(participantid, session, subject_condition, graph_condition) %>% 
  summarise(subject_mean_rating = mean(rating, na.rm = TRUE)) %>% 
  arrange(participantid)


#Calculate subject difference rating for session 1
##(non-truncated mean rating - truncated mean rating)
subject_difference_df <- subject_mean_df %>% 
  spread(graph_condition, subject_mean_rating) %>% 
  mutate(difference =  truncated - control)

#Calculate session difference for difference rating 
##(difference for session 2 - difference for session 1)
subject_difference_session_df <- subject_difference_df %>% 
  select(-c(control, truncated)) %>% 
  spread(session, difference) %>% 
  mutate(difference =  `2` - `1`)


#Calculate subject overall graph literacy score
##(sum of graph literacy items)
subject_graphliteracy_df <- graphliteracy_df %>%
  group_by(subject_condition, participantid) %>%
  summarise(graphliteracy_sum_rating = sum(rating)) 


#Create mixed effects df
##(combination of ratings, overall graph literacy scores and some demographic questions --- education, gender and age)
models_df <- full_join(full_join(subject_graphliteracy_df, demographic_df[, c("participantid", "dem_ed", "dem_gender", "dem_age")]), rating_df)


##Create lm difference df
##(df with subject truncation effect scores (difference between truncated and control) + all demographics and graph literacy scores) 
models_difference_df <- left_join(left_join(subject_difference_df,subject_graphliteracy_df), demographic_df[, c("participantid", "dem_ed", "dem_gender", "dem_age")])



#Create trimmed timing df
##(trims anything past 2 standard deviations from each participant's individual mean for each condition)
trimmed_timing_df <- timing_df %>%
  group_by(participantid, subject_condition, graph_condition) %>%
  mutate(avg = mean(time), stdev = sd(time)) %>%
  filter(time <= 2*stdev+avg) %>%
  as.data.frame()

```

--------------

## Methods

### Participants


```{r general participant information}
n <- demographic_df %>% 
  summarise(n())
```


```{r general participant information gender}
gender <- demographic_df %>% 
  group_by(dem_gender) %>% 
  summarise(n = n())

gender
```


```{r general participant information age}
age <- demographic_df %>% 
  summarise(mean_age = mean(dem_age), sd_age = sd(dem_age), 
            median_age = median(dem_age), min_age= min(dem_age), 
            max_age = max(dem_age), range_age = max(dem_age)-min(dem_age))

age
```


`r text_spec(n, bold = T)` (`r text_spec(gender[gender$dem_gender == "female",]$n, bold = T)` women, M~age~ = `r text_spec(round(age$mean_age, 2), bold = T)`, SD~age~ = `r text_spec(round(age$sd_age, 2), bold = T)`) completed both sessions of Study 4. 

175 people completed session 1. 157 returned to complete session 2.  `r text_spec(157/175*100, bold = T)`% return rate. 

All participants reported the United States as their location and had a previous task approval rate that was equal to or exceeded 85%. 

```{r general participant information education}
education <- demographic_df %>% 
  group_by(dem_ed) %>% 
  summarise (n = n()) %>%
  mutate(percentage = n / sum(n)*100)

education
```

`r text_spec(round(sum(education[education$dem_ed >= 5,]$percentage)), bold = T)`% reported having at least a Bachelorâ€™s degree.  The samples also exhibited a range of graph literacy (see Table 1).

Achieved power for main effects
```{r}
library(pwr)

# for the smallest observed cohen's d
pwr.t.test (n = 77, d = 0.40, sig.level = 0.05, power = NULL, type = "paired")

```

```{r summary statistics for graph literacy}
#Cronbach's Alpha
library(psych)

alpha <- graphliteracy_df %>% 
  spread(graphliteracy_question, rating) %>% 
  select(-group) %>% 
  psych::alpha()

#Data Summary
subject_graphliteracy_summary <- subject_graphliteracy_df %>%
  ungroup() %>% 
  summarise(n = n(), 
            mean = mean(graphliteracy_sum_rating), 
            sd = sd(graphliteracy_sum_rating), 
            median = median(graphliteracy_sum_rating),
            min= min(graphliteracy_sum_rating), 
            max = max(graphliteracy_sum_rating), 
            range=max(graphliteracy_sum_rating)-min(graphliteracy_sum_rating)) %>% 
  mutate(alpha = round(alpha$total$std.alpha,2))

subject_graphliteracy_summary
```

### Exercise Check

79 people did not complete exercise since they were in the NO WARNING condition. 2 other people did not complete the exercise at all. 

```{r}
exercise_check <- rating_df %>% 
  filter(subject_condition == "warning") %>% 
  group_by(participantid, check) %>% 
  summarise(n()) %>% 
  group_by(check) %>% 
  summarise(n = n()) %>% 
  mutate(percentage = n / sum(n)*100)
```

`r text_spec(exercise_check[exercise_check$check == "wrong" & !is.na(exercise_check$check),]$n, bold = T)` did not get the manipulation check question right. Accuracy was `r text_spec(round(exercise_check[exercise_check$check == "right" & !is.na(exercise_check$check),]$percentage, 3), bold = T)`%

For this report, `r if(Exclude_Exercise_Check == FALSE){paste("no")} else{paste(participants_excluded$n)}` participants are being excluded from analysis. If you want to see results when participants who got the exercise wrong are excluded/included, you can go to the section called Exclusions (at the top of this file) and change **Exclude_Exercise_Check <- TRUE**


## Results

```{r subject_mean_summary by session}
subject_mean_summary <- subject_mean_df %>% 
group_by(session, subject_condition, graph_condition) %>% 
summarise(n = n(), mean = mean(subject_mean_rating), 
            sd = sd(subject_mean_rating), 
            median = median(subject_mean_rating),
            min= min(subject_mean_rating), max = max(subject_mean_rating), 
            range =max(subject_mean_rating)-min(subject_mean_rating))

subject_mean_summary
```


### The truncation effect 

We first replicated our central effect of interest: the truncation effect. 


```{r subject_mean_main}
subject_mean_main <- subject_mean_df %>% 
group_by(graph_condition) %>% 
summarise(n = n(), mean = mean(subject_mean_rating), 
            sd = sd(subject_mean_rating), 
            median = median(subject_mean_rating),
            min= min(subject_mean_rating), max = max(subject_mean_rating), 
            range =max(subject_mean_rating)-min(subject_mean_rating))

subject_mean_main

```


We found that average ratings for truncated graphs was higher than ratings for control graphs: M~control~ = `r text_spec(round(subject_mean_main$mean[subject_mean_main$graph_condition=="control"],2), bold =T)`, SD = `r text_spec(round(subject_mean_main$sd[subject_mean_main$graph_condition=="control"],2), bold =T)`; M~truncated~ = `r text_spec(round(subject_mean_main$mean[subject_mean_main$graph_condition=="truncated"],2), bold =T)`, SD = `r text_spec(round(subject_mean_main$sd[subject_mean_main$graph_condition=="truncated"],2), bold =T)`.


```{r}
subject_mean_main_df <- subject_mean_df %>% 
  group_by(participantid, subject_condition, graph_condition) %>% 
  summarise(subject_mean_rating = mean(subject_mean_rating))
```

```{r effect size for main effect}
cohen_d <- effsize::cohen.d(subject_mean_main_df$subject_mean_rating, subject_mean_main_df$graph_condition, paired = TRUE, na.rm = TRUE)

cohen_d
```

```{r t test for main effect}
t_test <- t.test(subject_mean_rating ~ graph_condition, subject_mean_main_df, paired = TRUE)

t_test
```


This main effect was statistically significant: t(`r text_spec(round(t_test$parameter,2), bold = T)`) = `r text_spec(abs(round(t_test$statistic,2)), bold = T)`, p < `r text_spec(format(t_test$p.value,scientific = T), bold = T)`, 95% CI of difference = [0.72, 0.92],  d = `r text_spec(abs(round(cohen_d$estimate,2)), bold = T)`. 


```{r truncation effect direction}
truncation_effect_direction <- subject_difference_df %>% 
  mutate(direction = ifelse(difference > 0, "expected", "unexpected")) %>%
  group_by(session, direction) %>% 
  summarise(n= n()) %>% 
  mutate(percentage = n / sum(n)*100)

truncation_effect_direction           
```


Most participants in both sessions showed an overall truncation effect: `r text_spec(round(truncation_effect_direction[truncation_effect_direction$direction == "expected" & truncation_effect_direction$session == "1",]$percentage, 2), bold = T)`% of participants in Session 1 (`r text_spec(round(truncation_effect_direction[truncation_effect_direction$direction == "expected"& truncation_effect_direction$session == "1",]$n), bold = T)` of `r text_spec(n, bold = T)`) and `r text_spec(round(truncation_effect_direction[truncation_effect_direction$direction == "expected" & truncation_effect_direction$session == "2",]$percentage,2), bold = T)`% of participants in Session 2 (`r text_spec(round(truncation_effect_direction[truncation_effect_direction$direction == "expected"& truncation_effect_direction$session == "1",]$n), bold = T)` of `r text_spec(n, bold = T)`) .

## 2 x 2 x 2 LMEM

Next, we computed a linear mixed-effects model with graph type (0 = control, 1 = truncated), warning condition (0 = no warning, 1 = warning), and timepoint (session 1 or 2) as binary fixed factors, with the first listed condition as the reference group for each factor. The outcome variable was graph ratings, and participant was modeled as a random effect. Full model parameters are available in Table S2 . Consistent with the results above, we found a statistically significant and large simple effect of graph type (b = 1.16, t = 20.66, p < .0001) and a statistically significant interaction between graph type and warning condition (b = -0.54, t = 6.39, p < .0001), such that participants given an explanatory warning selectively rated truncated graphs lower.

```{r echo=TRUE}

model_full <- lmer(rating ~ subject_condition * graph_condition * session + (1 | participantid) * (1 | question), models_df)
summary_model_full <- summary(model_full)
summary_model_full <- as.data.frame(summary_model_full$coefficients)

``` 

### Check model assumptions
```{r echo=FALSE}

# Predicted versus Data
predictions <- predict(model_full)

model_full %>% augment() %>% 
  ggplot()  + 
  geom_point(aes(.fitted, rating), alpha = .1) + 
  geom_smooth(aes(.fitted, rating), method = "lm", se = FALSE, color = "lightgrey") + 
labs(x = "Actual", y = "Fitted") + 
  coord_cartesian(ylim=c(1, 7), xlim = c(1,7)) + 
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  scale_x_continuous(breaks=seq(1, 7, 1)) +
  #facet_grid(subject_condition~graph_condition) +
  theme_bw()
  
# Residuals versus Fitted
residuals <- residuals(model_full)

model_full %>% augment() %>% 
  ggplot()  + 
  geom_point(aes(.fitted, residuals), alpha = .1) + 
  geom_smooth(aes(.fitted, residuals), se = FALSE, color = "lightgrey") + 
  scale_x_continuous(breaks=seq(1, 7, 1)) +
  #facet_grid(subject_condition~graph_condition) +
  theme_bw()

# Residuals are ~normally distributed
library(lattice)
qqmath(model_full)

```

### Table 2
https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
```{r echo=FALSE}
##Confidence Intervals

# works
ci_model_full <- confint(model_full, "beta_", level = 0.95, method = c("boot"), nsim = 1000,  seed = 833, boot.type = c("perc"), FUN=NULL, quiet=FALSE, oldNames = TRUE, .progress = "txt")

###

ci_model_full <- as.data.frame(ci_model_full)


## Create and Clean Table
table_full <- merge(summary_model_full, ci_model_full, by = "row.names")
numVars <- sapply(table_full, is.numeric) 
table_full[numVars][,-c(5)] <- lapply(table_full[numVars][,-c(5)], round, digits = 2)
table_full[c(6)] <- lapply(table_full[c(6)], round, digits = 5)


table_full %<>% 
  mutate("95% CI of Estimate" =  paste("[", `2.5 %`, ",", `97.5 %`, "]", sep = "")) %>% select(Row.names, Estimate, `95% CI of Estimate`, `Std. Error`, `t value`, `Pr(>|t|)`)

table_full
```

We did not find evidence for our hypothesis that the protective effect of an explanatory warning would fade by the second session. The 3-way interaction between timepoint, warning condition, and graph type was not statistically significant (t = 1.43, p = .15).

## Figure 7
```{r}

# calculating r for the correlation- and difference-adjusted CIs of the means
df <- subject_mean_df %>%
  pivot_wider(
    names_from = graph_condition,
    values_from = subject_mean_rating
  )

r = cor(df$control, df$truncated)

#Flat Violin Set Up

errbar_lims <- subject_mean_df %>% 
  group_by(graph_condition, subject_condition, session) %>% 
  summarise(mean=mean(subject_mean_rating), 
            se = sd(subject_mean_rating)/sqrt(n()), 
           upper = mean + (2 * sqrt(1 - r) * sqrt(2) * se),
           lower = mean - (2 * sqrt(1 - r) * sqrt(2) * se))


subject_mean_df %<>% 
  mutate(subject_condition_2 =ifelse(subject_condition == "no warning", 1, 2))


```

```{r figure 7}
#Flat Violin Pink and Blue
ggplot(subject_mean_df, aes(x = session, y = subject_mean_rating, fill = graph_condition)) +
  geom_flat_violin(position = position_nudge(x = .15, y = 0), adjust = 1.5, trim = FALSE, alpha = .9, colour = NA) +
   facet_grid(~as.character(subject_condition)) +
  geom_point(aes(color = graph_condition), position = position_jitter(0.1), size = 2, shape = 20,  alpha =0.7) +
  geom_point(data=errbar_lims, aes(x=session, y=mean, color = graph_condition), position = position_nudge(x = -0.28, y = 0)) +
  geom_errorbar(data=errbar_lims, aes(x=session, y=mean, ymax=upper, ymin=lower, color = graph_condition),stat='identity', size = 1, width=.15, position = position_nudge(x = -0.28, y = 0)) +
  #Color
  scale_colour_manual(values = c("#000064", "#FC5167")) +
  scale_fill_manual(values = c("#000064", "#FC5167")) +
  #Axis
  coord_cartesian(ylim=c(1, 7)) + 
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  #Theme
  raincloud_theme +
  guides(fill = guide_legend(reverse=TRUE), color = guide_legend(reverse=TRUE))+
  ylab("mean rating") +
  xlab("session") +
  ggtitle("Study 4. correlation- and difference-adjusted CIs")

# ggsave('../figures/figure7.png', plot = last_plot(), width = 8, height = 5)
# ggsave('../figures/figure7.tiff', plot = last_plot(), width = 8, height = 5, device = "tiff")

```

## Follow-up analyses

First, visualize the interaction:
```{r echo=FALSE}

model_full <- lmer(rating ~ subject_condition * graph_condition * session + (1 | participantid) * (1 | question), models_df)

# 2-way
emmip(model_full, graph_condition ~ subject_condition) # interaction
emmip(model_full, subject_condition ~ session) # interaction?
emmip(model_full, graph_condition ~ session) # looks parallel

# 3-ways
emmip(model_full, graph_condition ~ session | subject_condition)
# emmip(model_full, graph_condition ~ subject_condition | session )
# emmip(model_full, subject_condition ~ session | graph_condition)
# emmip(model_full, subject_condition ~  graph_condition | session)
# emmip(model_full, session ~ subject_condition | graph_condition)
# emmip(model_full, session ~ graph_condition | subject_condition)

```

The, compute conditional contrasts. We estimate degrees of freedom uses the Satterthwaite method, to be consistent with the approach used in `lmerTest`.

```{r}

#emm1 <- emmeans(model_full, pairwise ~ subject_condition:graph_condition:session)
#emm1$contrasts

# graph type x session
s_g <- emmeans(model_full, pairwise ~ session | graph_condition, lmer.df = "satterthwaite")
s_g
confint(s_g$contrasts)

compare <- pairs(pairs(emmeans(model_full, ~ session|graph_condition)), by = NULL)
compare
confint(compare)

# session x warning
se_su <- emmeans(model_full, pairwise ~ session | subject_condition, lmer.df = "satterthwaite")
se_su
confint(se_su)

compare <- pairs(pairs(emmeans(model_full, ~ subject_condition|session)), by = NULL)
compare
confint(compare)

# graph type x warning

g_s <- emmeans(model_full, pairwise ~ graph_condition | subject_condition, lmer.df = "satterthwaite")
g_s
confint(g_s)

s_g <- emmeans(model_full, pairwise ~ subject_condition | graph_condition, lmer.df = "satterthwaite")
s_g
confint(s_g)

compare <- pairs(pairs(emmeans(model_full, ~ subject_condition|graph_condition)), by = NULL)
confint(compare)


```

# Supplemental Information

## Methods

### Participants

```{r supplemental participant informatinon language}
langauge <- demographic_df %>% 
  group_by(dem_language) %>% 
  summarise(n = n())

other_language <- demographic_df %>% 
  group_by(dem_language_2_text) %>% 
  summarise(n = n())
```

`r text_spec(langauge[2,]$n, bold = T)` participants reported English as their first language,  and `r text_spec(other_language[2,]$n, bold = T)` reported `r text_spec(other_language[2,]$dem_language_2_text, bold = T)` as their first language. 

```{r supplemental participant information education}
education <- demographic_df %>% 
  group_by(dem_ed) %>% 
  summarise (n = n()) %>%
  mutate(percentage = n / sum(n)*100)

education
   
```

`r text_spec(round(sum(education[education$dem_ed >= 5,]$percentage)), bold = T)`% of participants reported having at least a Bachelorâ€™s degree. 

```{r supplemental participant information duration}
duration_1 <- demographic_df %>% 
  summarise(mean_duration = mean(duration_min_1), 
            sd_duration = sd(duration_min_1), 
            median_duration = median(duration_min_1), 
            min_duration= min(duration_min_1), 
            max_duration = max(duration_min_1), 
            range_duration = max(duration_min_1)-min(duration_min_1))

duration_1

duration_2 <- demographic_df %>% 
  summarise(mean_duration = mean(duration_min_2), 
            sd_duration = sd(duration_min_2), 
            median_duration = median(duration_min_2), 
            min_duration= min(duration_min_2), 
            max_duration = max(duration_min_2), 
            range_duration = max(duration_min_2)-min(duration_min_2))

duration_2
```

Session 1 of the experiment took participants an average of M~duration~ = `r text_spec(round(duration_1$mean_duration, 2), bold = T)` minutes, (SD~duration~ = `r text_spec(round(duration_1$sd_duration, 2), bold = T)` minutes). 

Session 2 of the experiment took participants an average of M~duration~ = `r text_spec(round(duration_2$mean_duration, 2), bold = T)` minutes, (SD~duration~ = `r text_spec(round(duration_2$sd_duration, 2), bold = T)` minutes). 

## Results

## Clarifying Timepoint Interactions

### Marginal Means

To clarify the effects of timepoint on people's ratings with graphs, we estimated marginal means (EMMs) for contrasts of interest (Table S3).

```{r echo=TRUE}

#model
model_full <- lmer(rating ~ subject_condition * graph_condition * session + (1 | participantid), models_df)

# estimated marginal means pair-wise comparisons for all combinations of IVs
emm1 = emmeans(model_full, specs = pairwise ~ graph_condition + session + subject_condition, lmer.df = "satterthwaite")

# estimated marginal means along with the SEs and CIs
# Table S3
  emm1$emmeans
  
  # comparisons -- automatically adjusts for multiple comparisons
  #emm1$contrasts
  
```

```{r figure S2, echo=FALSE}

  # make a tibble
  emm1.df <-
    emm1$emmeans %>% broom::tidy()

  #plot marginal means
   emm1.df %>%
    ggplot(aes(session, estimate, ymin=asymp.LCL, ymax=asymp.UCL)) +
    geom_pointrange(aes(color = graph_condition)) +
     facet_grid(~subject_condition) +
     theme_minimal() +
     ylab("estimated marginal means") +
     ylim(3,5.5) +
     ggtitle("study 4 EMMs") +
     guides(fill = guide_legend(reverse=TRUE), color = guide_legend(reverse=TRUE))

```

Compare with descriptive means
```{r}
  
df <- models_df %>%
  group_by(graph_condition, session, subject_condition) %>%
  summarise(
    mean = mean(rating, na.rm = TRUE),
    sd = sd(rating, na.rm = TRUE),
    num = n(),
    se = sd / sqrt(num)
  ) %>%
  mutate(lower = mean - se, upper = mean + se)

df

df %>% ggplot(aes(session, mean, ymin=lower, ymax=upper)) +
    geom_point(aes(color = graph_condition)) +
    geom_linerange(aes(color = graph_condition)) +
     facet_grid(~subject_condition) +
     theme_minimal() +
     ylab("mean graph ratings") +
     ylim(3,5.5) +
     ggtitle("study 4") + 
  guides(fill = guide_legend(reverse=TRUE), color = guide_legend(reverse=TRUE))

```


### Timepoint and Graph Type
First, we compared timepoints for control and truncated graphs (averaging over warning condition). We found that participants' ratings tended to be lower on the second session for both control and truncated graphs The estimated difference between session 1 and session 2 for control graphs was 0.16 (EMM1 = 3.73, EMM2 = 3.57;  p = .0002); the estimated difference between session 1 and session 2 for truncated graphs was 0.23 (EMM1 = 3.73, EMM2 = 3.57;  p = .0002; p < .0001).
  
```{r}
# compare levels of session for each graph_condition (averaging over warning condition)

emm2 = emmeans(model_full, specs = pairwise ~ session|graph_condition, type = "response")
emm2

```

To further explore the interaction between timepoint and graph type, we computed a linear mixed-effects model with graph type (0 = control, 1 = truncated) and timepoint (session 1 or 2) as binary fixed factors. The outcome variable was graph ratings, and participant and item were included as crossed random effects. We found statistically significant simple effects of graph type (as expected; b = 0.94, t = 12.80, p < .0001) and timepoint (b = -0.15, t = -4.93, p < .0001). The interaction between graph type and timepoint was not statistically significant (t = -1.80, p = .07). Overall, participants rated the differences depicted by bar graphs as smaller in the second session compared to the first session; this was not due to a difference in materials, as the materials were counter-balanced.

```{r}

summary(
  lmer(rating ~ graph_condition * session + (1 | participantid) * (1 | question), models_df)
)

```

### Timepoint and Warning Condition

```{r}
# compare levels of session for each warning condition (averaging over graph condition)

emm3 = emmeans(model_full, specs = pairwise ~ session|subject_condition, type = "response")
emm3

```

To further explore the interaction between timepoint and warning condition (p = .06; Table S3), we computed a linear mixed-effects model with warning condition (0 = no warning, 1 = warning) and timepoint (session 1 or 2) as binary fixed factors. The outcome variable was graph ratings, and participant and item were included as crossed random effects. As expected, we found a statistically significant simple effect of warning condition (b = -0.33, t = 2.52, p = .02), consistent with the protective effect of a warning. The simple effect of timepoint was also statistically significant: b = -0.16, t = 4.53, p < .0001. The interaction between warning condition and timepoint was not statistically significant (t = 1.44, p = .15). This evidence also supports the claim that participants rated the differences depicted by bar graphs as smaller in the second session compared to the first session.n.

```{r}

summary(
  lmer(rating ~ subject_condition * session + (1 | participantid) * (1 | question), models_df)
)

```

### Interaction Plots
Figure S3
```{r echo=FALSE}

# plot 1. warning and graph type
plot1 <- emmip(model_full, graph_condition ~ subject_condition) # warning and graph type
plot1 + 
  ylab("linear prediction") + xlab("graph type") +
  interaction_theme +
  scale_colour_manual(values = c("#000A77", "#FF6171"))+ #Color
  scale_fill_manual(values = c("#000A77", "#FF6171"))+
  coord_cartesian(ylim=c(2, 6)) + #Axis
  scale_y_continuous(breaks=seq(2, 6, .5))
  #guides(fill = guide_legend(reverse=TRUE), color = guide_legend(reverse=TRUE))

# plot 2. session and warning
emmip(model_full, subject_condition ~ session) +
  ylab("linear prediction") + xlab("session") +
  interaction_theme +
  scale_colour_manual(values = c("#009B9F", "#C75DAA"))+ #Color
  scale_fill_manual(values = c("#009B9F", "#C75DAA"))+
  coord_cartesian(ylim=c(3.5, 5)) + #Axis
  scale_y_continuous(breaks=seq(3.5, 5, .5))

#plot 3. session and graph type

emmip(model_full, graph_condition ~ session) + 
 ylab("linear prediction") + xlab("session") +
  interaction_theme +
  scale_colour_manual(values = c("#000A77", "#FF6171"))+ #Color
  scale_fill_manual(values = c("#000A77", "#FF6171"))+
  coord_cartesian(ylim=c(3, 5)) + #Axis
  scale_y_continuous(breaks=seq(3, 5, .5))

  
# exploratory plot 4: session*graph type*warning condition
emmip(model_full, session  ~ graph_condition * subject_condition) +
  #ylab("linear prediction") + xlab("warning condition & session") +
  interaction_theme +
  scale_colour_manual(values = c("#000A77", "#FF6171"))+ #Color
  scale_fill_manual(values = c("#000A77", "#FF6171"))+
  coord_cartesian(ylim=c(2, 6)) + #Axis
  scale_y_continuous(breaks=seq(2, 6, .5))

```

### Difference and session

```{r include=FALSE}
   
model_difference<- lm(difference ~ subject_condition*session, models_difference_df)

emm_sessionwarning = emmeans(model_difference, specs = pairwise ~ session|subject_condition, type = "response", lm.df = "satterthwaite")

```

## Model Comparisons
This serve as tests for main effects.

With and without session
Model including session is statistically different than the one without session
```{r}

model_nosession <- lmer(rating ~ subject_condition + graph_condition + subject_condition:graph_condition + (1 | participantid), models_df)

anova(model_full, model_nosession)

```

With and without warning condition
Models are statistically different
```{r}

model_nowarningcondition <- lmer(rating ~ session + graph_condition + session:graph_condition + (1 | participantid), models_df)

anova(model_full, model_nowarningcondition)

```

With and without 3-way interaction
The model with the 3-way interaction is NOT statistically different from the model without the 3-way interaction
```{r}

model_no3way <- lmer(rating ~ subject_condition + graph_condition + session + subject_condition:graph_condition + session:graph_condition + session:subject_condition + (1 | participantid), models_df)

anova(model_full, model_no3way)

```

With and without 2-way interactions

1. Evaluating graph:warning: statistically different (p < .0001)
```{r}

model_no3way <- lmer(rating ~ subject_condition + graph_condition + session + subject_condition:graph_condition + session:graph_condition + session:subject_condition + (1 | participantid), models_df)

model_nographwarning <- lmer(rating ~ subject_condition + graph_condition + session + session:graph_condition + session:subject_condition + (1 | participantid), models_df)

anova(model_no3way, model_nographwarning)

```

2. Evaluating session:graph type
NOT statistically different (p = .17)
```{r}

model_nographsession <- lmer(rating ~ subject_condition + graph_condition + session + subject_condition:graph_condition + session:subject_condition + (1 | participantid), models_df)

anova(model_no3way, model_nographsession)

```

2. Evaluating session:warning
NOT statistically significant (p = .21)
```{r}

model_nosessionwarning <- lmer(rating ~ subject_condition + graph_condition + session + subject_condition:graph_condition + session:graph_condition + (1 | participantid), models_df)

anova(model_no3way, model_nosessionwarning)

```

## Graph Literacy (Supplemental Information)

#### Main Effect

Graph literacy does not explain the size of the truncation effect
```{r graphliteracy model}
graphliteracymodel <- lmer(difference ~ graphliteracy_sum_rating + (1 | participantid), models_difference_df)
summary_graphliteracymodel <- summary(graphliteracymodel)
summary_graphliteracymodel
```


Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = graphliteracy_sum_rating, y = difference))+
  geom_smooth(method = lm, color = "#510D73", fill = "#510D73") +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("graph literacy score")+
  ggtitle("Figure SI4 Graph Literacy")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))

ggsave('../figures/figureSI4_graphliteracy.png', plot = last_plot(), width = 6, height = 4)
```

#### Interaction with warning

Graph literacy does not significantly predict the size of the truncation effect even when you add in warning condition. 

```{r graph literacy and subject condition}
# graph literacy and subject condition 

model_literacy_warning<- lm(difference ~ graphliteracy_sum_rating * subject_condition, models_difference_df)

##Model
summary_model_literacy_warning <- summary(model_literacy_warning)

summary_model_literacy_warning
```


Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = graphliteracy_sum_rating, y = difference, color = subject_condition, fill = subject_condition))+
  geom_smooth(method = lm) +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("graph literacy score")+
  ggtitle("Figure SI3 Graph Literacy by Warning Condition")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))+
  scale_colour_brewer(type = "div", palette = "Dark2")+
  scale_fill_brewer(type = "div", palette = "Dark2")

ggsave('../figures/figureSI3_graphliteracy_subjectcondition.png', plot = last_plot(), width = 8, height = 4)
```

#### Interaction with session

Graph literacy does not significantly predict the size of the truncation effect even when you add in warning session. 

```{r graph literacy and session}

models_difference_df$session <- as.factor(models_difference_df$session)

# graph literacy and subject condition 

model_literacy_session<- lm(difference ~ graphliteracy_sum_rating * session, models_difference_df)

##Model
summary_model_literacy_session <- summary(model_literacy_session)
summary_model_literacy_session <- as.data.frame(summary_model_literacy_session$coefficients)

summary_model_literacy_session

```

Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = graphliteracy_sum_rating, y = difference, color = session, fill = session))+
  geom_smooth(method = lm) +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("graph literacy score")+
  ggtitle("Figure SI3 Graph Literacy by Warning Condition")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))+
  scale_colour_brewer(type = "div", palette = "Dark2")+
  scale_fill_brewer(type = "div", palette = "Dark2")

# ggsave('../figures/figureSI4_graphliteracy_session.png', plot = last_plot(), width = 8, height = 4)
```


## Education

Education and graph literacy 
```{r}
models_difference_df$dem_ed <- as.numeric(models_difference_df$dem_ed)

education_graphliteracy <- lm(graphliteracy_sum_rating ~ dem_ed, models_difference_df)
summary(education_graphliteracy)
```

## Age

#### Main Effect

```{r age model}
agemodel <- lm(difference ~ dem_age, models_difference_df)
summary_agemodel <- summary(agemodel)
summary_agemodel
```


Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = dem_age, y = difference))+
  geom_smooth(method = lm, color = "#510D73", fill = "#510D73") +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("age")+
  ggtitle("Figure SI3 Age")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))

ggsave('../figures/figureSI4_age.png', plot = last_plot(), width = 6, height = 4)
```

#### Interaction with warning


```{r age and subject condition}
# age and subject condition 
age_subjectcondition <- lm(difference ~ dem_age * subject_condition, models_difference_df)
summary(age_subjectcondition)
```


Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = dem_age, y = difference, color = subject_condition, fill = subject_condition))+
  geom_smooth(method = lm) +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("age")+
  ggtitle("Figure SI3 Age by Warning Condition")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))+
  scale_colour_brewer(type = "div", palette = "Dark2")+
  scale_fill_brewer(type = "div", palette = "Dark2")

ggsave('../figures/figureSI4_age_subjectcondition.png', plot = last_plot(), width = 8, height = 4)
```

#### Interaction with session


```{r age and session}
models_difference_df$session <- as.factor(models_difference_df$session)

# age and subject condition 
age_session <- lm(difference ~ dem_age * session, models_difference_df)
summary(age_session)
```

Truncation effect is mean rating for truncated graphs - mean rating for control graphs. 

```{r}
ggplot(models_difference_df, aes(x = dem_age, y = difference, color = session, fill = session))+
  geom_smooth(method = lm) +
  geom_jitter(alpha = 0.7)+
  ylab("truncation effect")+
  xlab("age")+
  ggtitle("Figure SI3 Age by Warning Condition")+
  raincloud_theme+
  theme(axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'))+
  scale_colour_brewer(type = "div", palette = "Dark2")+
  scale_fill_brewer(type = "div", palette = "Dark2")

ggsave('../figures/figureSI4_age_subjectcondition.png', plot = last_plot(), width = 8, height = 4)
```


### Item Analysis (Supplemental Information)

##### Main Effect of Warning
Here we summarise the data for each item. This is helpful to identify if the effect is driven by a few graphs or if it is seen across all graphs in the materials. 

```{r item analysis}
item_mean_df <- rating_df %>% 
  group_by(question,subject_condition) %>% 
  summarise(item_mean_rating = mean(rating)) %>% 
  arrange(question)
```

```{r}
item_mean_df %>% 
  spread(subject_condition, item_mean_rating) %>%
  mutate(diff=`no warning`- warning)
```

```{r}
item_mean_summary <- item_mean_df %>% 
  spread(subject_condition, item_mean_rating) %>%
  mutate(diff=`no warning`- warning) %>% 
  ungroup() %>% 
  summarise(n = n(), mean = mean(diff), sd = sd(diff), 
            median = median(diff), min= min(abs(diff)), 
            max = max(abs(diff)), 
            range = max(abs(diff))-min(abs(diff)))

item_mean_summary
```


```{r}
ggplot(rating_df, aes(x = subject_condition, y = rating, group = subject_condition, color = subject_condition))+
  geom_jitter(width = 0.23, alpha = 0.5)+
  stat_summary(fun.y = mean, geom = "point", color = "black") + 
  stat_summary(fun.y=mean, color="black", geom="line", aes(group = 1))+
  facet_wrap(~as.factor(question))+
  scale_colour_brewer(palette = "Dark2", direction=-1)

# ggsave("../figures/figureSI4_item_analysis.png", device = "png", width = 16, height = 8, plot = last_plot(),scale = 1)
```

```{r}
item_mean_df %>% 
  spread(subject_condition, item_mean_rating) %>%
  mutate(diff=`no warning`- warning) %>% 
  filter(diff <0)
```


The effect of warning was observed for all graphs except graph 2, 12 and 40. On average, the 7-point ratings were `r text_spec(round(item_mean_summary$mean,2), bold = T)` (SD = `r text_spec(round(item_mean_summary$sd,2), bold = T)`) higher when graphs were seen in the no warning condition than when they were seen in the warning condition. The maximum average absolute difference between the no warning and the warning conditions was for graph 7 M = `r text_spec(round(item_mean_summary$max,2), bold = T)`. The minimum average absolute difference was for graph 2 where M = `r text_spec(round(item_mean_summary$min,2), bold = T)`.


##### Warning interaction with graph type 

```{r eval=FALSE, include=FALSE}
ggplot(rating_df, aes(x = graph_condition, y = rating, group = subject_condition, color = subject_condition))+
  geom_jitter(width = 0.23, alpha = 0.5)+
  stat_summary(fun.y = mean, geom = "point", color = "black", aes(group = subject_condition)) + 
  stat_summary(fun.y=mean, geom="line", aes(group = subject_condition))+
  facet_wrap(~as.factor(question))+
  scale_colour_brewer(palette = "Dark2", direction=-1)

# ggsave("../figures/figureSI4_item_analysis_warning.png", device = "png", width = 16, height = 8, plot = last_plot(),scale = 1)
```



##### Session interaction with graph type 

```{r eval=FALSE, include=FALSE}
rating_df$session <- as.factor(rating_df$session)

ggplot(rating_df, aes(x = graph_condition, y = rating, group = session, color = session))+
  geom_jitter(width = 0.23, alpha = 0.5)+
  stat_summary(fun.y = mean, geom = "point", color = "black", aes(group = session)) + 
  stat_summary(fun.y=mean, geom="line", aes(group = session))+
  facet_wrap(~as.factor(question))+
  scale_colour_brewer(palette = "Dark2", direction=-1)

# ggsave("../figures/figureSI4_item_analysis_session.png", device = "png", width = 16, height = 8, plot = last_plot(),scale = 1)
```


#### Timing

```{r supplemental information timing}

Trimming <- FALSE

if(Trimming == TRUE){timing_t_df = trimmed_timing_df
} else{timing_t_df = timing_df}
```


Timing information is in seconds. 

You can choose to trim or not timing data. By default any timing that is 2 standard deviations away from the mean (for each participant for each condition) is trimmed. 

For this report, any timing that is 2 standard deviations away from the mean (for each participant for each condition) `r if(Trimming == TRUE){paste("WAS")} else{paste("WAS NOT")}` trimmed.  If you want to see results when participants who got the exercise wrong are excluded/included, you can go to the section called Exclusions (at the top of this file) and change **Trimming <- FALSE**


```{r timing interaction}
subject_timing <-  timing_t_df %>%
  filter(question != "instructions") %>% 
  group_by(participantid, graph_condition, subject_condition,session) %>%
  summarise(n = n(), subject_mean_timing = mean(time))

#Data Summary
subject_timing_interaction_summary <- subject_timing %>% 
  group_by(session, subject_condition, graph_condition) %>% 
  summarise(n = n(), mean = mean(subject_mean_timing), 
            sd = sd(subject_mean_timing), 
            median = median(subject_mean_timing), min= min(subject_mean_timing), 
            max = max(subject_mean_timing), 
            range = max(subject_mean_timing)-min(subject_mean_timing))

subject_timing_interaction_summary
```

```{r timing by session and graph condition}
#Data Summary
subject_timing_graph_summary <- subject_timing %>% 
  group_by(session, graph_condition) %>% 
  summarise(n = n(), mean = mean(subject_mean_timing), 
            sd = sd(subject_mean_timing), 
            median = median(subject_mean_timing), min= min(subject_mean_timing), 
            max = max(subject_mean_timing), 
            range = max(subject_mean_timing)-min(subject_mean_timing))

subject_timing_graph_summary
  
```

```{r timing by session and warning condition}
#Data Summary
subject_timing_warning_summary <- subject_timing %>% 
  group_by(session, subject_condition) %>% 
  summarise(n = n()/2, mean = mean(subject_mean_timing), 
            sd = sd(subject_mean_timing), 
            median = median(subject_mean_timing), min= min(subject_mean_timing), 
            max = max(subject_mean_timing), 
            range = max(subject_mean_timing)-min(subject_mean_timing))

subject_timing_warning_summary
```
